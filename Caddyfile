# ConfiguraÃ§Ã£o do proxy reverso com Load Balancing + HTTPS
# HTTPS: Cliente â†’ Caddy (HTTPS) â†’ Backends (HTTP)

# Servidor HTTPS (porta 443)
backend.local {
    # Caddy gera automaticamente certificado autoassinado para localhost
    
    # Rota /app1 - acessa apenas o servidor 1
    handle_path /app1* {
        reverse_proxy python-server-1:8000
    }

    # Rota /app2 - acessa apenas o servidor 2
    handle_path /app2* {
        reverse_proxy python-server-2:8000
    }

    # Rota /balanced - Load balancing com round-robin + health checks
    handle_path /balanced* {
        reverse_proxy python-server-1:8000 python-server-2:8000 {
            # Health check - verifica se o backend estÃ¡ respondendo
            health_uri /
            health_interval 10s
            health_timeout 5s
            health_status 200
        }
    }

    # Rota /balanced-random - Load balancing aleatÃ³rio
    handle_path /balanced-random* {
        reverse_proxy python-server-1:8000 python-server-2:8000 {
            lb_policy random
            health_uri /
            health_interval 10s
            health_timeout 5s
        }
    }

    # Rota /balanced-least - Encaminha para o servidor com menos conexÃµes
    handle_path /balanced-least* {
        reverse_proxy python-server-1:8000 python-server-2:8000 {
            lb_policy least_conn
            health_uri /
            health_interval 10s
            health_timeout 5s
        }
    }

    # Rota /balanced-ip - Sticky session por IP (mesmo cliente, mesmo servidor)
    handle_path /balanced-ip* {
        reverse_proxy python-server-1:8000 python-server-2:8000 {
            lb_policy ip_hash
            health_uri /
            health_interval 10s
            health_timeout 5s
        }
    }

    # PÃ¡gina inicial
    handle / {
        respond "Proxy Reverso Caddy com Load Balancing + HTTPS
        
Rotas disponÃ­veis:
- /app1 â†’ Servidor 1 apenas
- /app2 â†’ Servidor 2 apenas
- /balanced â†’ Load balancing Round-Robin (padrÃ£o)
- /balanced-random â†’ Load balancing AleatÃ³rio
- /balanced-least â†’ Menor nÃºmero de conexÃµes
- /balanced-ip â†’ Sticky session por IP

ðŸ”’ ConexÃ£o segura via HTTPS"
    }
}

# Redireciona HTTP (porta 80) para HTTPS (porta 443)
:80 {
    redir https://backend.local{uri} permanent
}