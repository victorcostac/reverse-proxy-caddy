cine.locadora.local {
    
    # Recursos estÃ¡ticos do Next.js - devem ser proxy para qualquer backend
    handle /_next/* {
        reverse_proxy frontend1:3000 frontend2:3000
    }
    
    handle /favicon.ico {
        reverse_proxy frontend1:3000 frontend2:3000
    }
    
    handle_path /app1* {
        reverse_proxy frontend1:3000
    }

    handle_path /app2* {
        reverse_proxy frontend2:3000
    }

    handle_path / {
        reverse_proxy frontend1:3000 frontend2:3000 {
            health_uri /
            health_interval 10s
            health_timeout 5s
            health_status 200
        }
    }

    # Rota /balanced-random - Load balancing aleatÃ³rio
    handle_path /balanced-random* {
        reverse_proxy frontend1:3000 frontend2:3000 {
            lb_policy random
            health_uri /
            health_interval 10s
            health_timeout 5s
        }
    }

    # Rota /balanced-least - Encaminha para o servidor com menos conexÃµes
    handle_path /balanced-least* {
        reverse_proxy frontend1:3000 frontend2:3000 {
            lb_policy least_conn
            health_uri /
            health_interval 10s
            health_timeout 5s
        }
    }

    # Rota /balanced-ip - Sticky session por IP (mesmo cliente, mesmo servidor)
    handle_path /balanced-ip* {
        reverse_proxy frontend1:3000 frontend2:3000 {
            lb_policy ip_hash
            health_uri /
            health_interval 10s
            health_timeout 5s
        }
    }

    handle /info {
        respond "Proxy Reverso Caddy com Load Balancing + HTTPS
        
Rotas disponÃ­veis:
- /app1 â†’ Servidor 1 apenas
- /app2 â†’ Servidor 2 apenas
- /balanced â†’ Load balancing Round-Robin (padrÃ£o)
- /balanced-random â†’ Load balancing AleatÃ³rio
- /balanced-least â†’ Menor nÃºmero de conexÃµes
- /balanced-ip â†’ Sticky session por IP

ðŸ”’ ConexÃ£o segura via HTTPS"
    }
}

:80 {
    redir https://backend.local{uri} permanent
}