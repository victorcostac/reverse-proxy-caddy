cine.locadora.local {
    
    # API Backend - proxy para o backend (para requisi√ß√µes client-side dos frontends)
    handle /api/* {
        reverse_proxy backend:8080
    }
    
    # Recursos est√°ticos do Next.js - devem ser proxy para qualquer backend
    handle /_next/* {
        reverse_proxy frontend1:3000 frontend2:3000
    }
    
    handle /favicon.ico {
        reverse_proxy frontend1:3000 frontend2:3000
    }
    
    handle_path /app1* {
        reverse_proxy frontend1:3000
    }

    handle_path /app2* {
        reverse_proxy frontend2:3000
    }

    # Rota /balanced-random - Load balancing aleat√≥rio
    handle_path /balanced-random* {
        reverse_proxy frontend1:3000 frontend2:3000 {
            lb_policy random
            health_uri /
            health_interval 10s
            health_timeout 5s
        }
    }

    # Rota /balanced-least - Encaminha para o servidor com menos conex√µes
    handle_path /balanced-least* {
        reverse_proxy frontend1:3000 frontend2:3000 {
            lb_policy least_conn
            health_uri /
            health_interval 10s
            health_timeout 5s
        }
    }

    # Rota /balanced-ip - Sticky session por IP (mesmo cliente, mesmo servidor)
    handle_path /balanced-ip* {
        reverse_proxy frontend1:3000 frontend2:3000 {
            lb_policy ip_hash
            health_uri /
            health_interval 10s
            health_timeout 5s
        }
    }

    handle /info {
        respond "Proxy Reverso Caddy com Load Balancing + HTTPS
        
Rotas dispon√≠veis:
- /app1 ‚Üí Servidor 1 apenas
- /app2 ‚Üí Servidor 2 apenas
- /balanced ‚Üí Load balancing Round-Robin (padr√£o)
- /balanced-random ‚Üí Load balancing Aleat√≥rio
- /balanced-least ‚Üí Menor n√∫mero de conex√µes
- /balanced-ip ‚Üí Sticky session por IP

üîí Conex√£o segura via HTTPS"
    }

    # Rota padr√£o - Load balancing para todas as outras rotas (/, /ator, /diretor, etc.)
    handle /* {
        reverse_proxy frontend1:3000 frontend2:3000 {
            health_uri /
            health_interval 10s
            health_timeout 5s
            health_status 200
        }
    }
}

:80 {
    redir https://cine.locadora.local{uri} permanent
}